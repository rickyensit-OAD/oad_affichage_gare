<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>OAD – Affichage Gare</title>

<style>
/* ===== BASE ===== */
body {
  margin: 0;
  background: #0a1f33;
  font-family: "Segoe UI", Arial, sans-serif;
  color: white;
  overflow: hidden;
}

/* ===== HEADER ===== */
header {
  background: #062033;
  padding: 2vh 2.5vw;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 0.4vh solid #00c8ff;
}

/* ===== HEADER LEFT ===== */
.header-left {
  display: flex;
  align-items: center;
  gap: 1.5vw;
}

.header-left img {
  height: 6vh;
  max-height: 60px;
}

header h1 {
  margin: 0;
  font-size: 3vw;
}

/* ===== HEADER RIGHT ===== */
.header-right {
  text-align: right;
}

#clock {
  font-size: 2.8vw;
  font-weight: bold;
}

#date {
  font-size: 1.6vw;
  opacity: 0.85;
}

/* ===== MAIN ===== */
.main {
  display: flex;
  height: calc(100vh - 14vh);
}

/* ===== TABLE ZONE ===== */
.table-zone {
  width: 65%;
  padding: 2vh 2vw;
  display: flex;
  flex-direction: column;
}

/* ===== TABLE ===== */
.table-header table,
.table-body table {
  width: 100%;
  border-collapse: collapse;
  font-size: 1.8vw;
}

/* ===== ALIGNEMENT COLONNES ===== */
colgroup col:nth-child(1) { width: 15%; }
colgroup col:nth-child(2) { width: 30%; }
colgroup col:nth-child(3) { width: 15%; }
colgroup col:nth-child(4) { width: 15%; }
colgroup col:nth-child(5) { width: 25%; }

/* ===== HEADER TABLE ===== */
.table-header th {
  background: #0d304a;
  padding: 1.5vh 1vw;
  border-bottom: 0.3vh solid #00c8ff;
  text-align: left;
}

/* ===== BODY SCROLL ===== */
.table-body {
  flex: 1;
  overflow: hidden;
}

.table-body td {
  padding: 1.2vh 1vw;
  line-height: 1.4;
  border-bottom: 1px solid #1e405a;
}

/* ===== STATUTS ===== */
.statut-ok { color: #4CAF50; font-weight: bold; }
.statut-embarquement { color: #FFC107; font-weight: bold; }
.statut-retard { color: #F44336; font-weight: bold; }
.statut-parti { color: #64B5F6; font-weight: bold; }

/* ===== PUB ===== */
.pub {
  width: 35%;
  background: black;
  position: relative;
  overflow: hidden;
}

.pub img {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
  opacity: 0;
  transition: opacity 1s ease-in-out;
}

.pub img.active {
  opacity: 1;
}

/* ===== TICKER ===== */
.ticker {
  position: fixed;
  bottom: 0;
  width: 100%;
  height: 6vh;
  background: #b30000;
  display: none;
  align-items: center;
  font-size: 2.2vw;
  font-weight: bold;
  overflow: hidden;
}

.ticker span {
  white-space: nowrap;
  padding-left: 100%;
  animation: scrollText 25s linear infinite;
}

@keyframes scrollText {
  from { transform: translateX(0); }
  to { transform: translateX(-100%); }
}
</style>
</head>

<body>

<header>
  <div class="header-left">
    <img src="https://imgur.com/z2Eg5pp.png" class="logo" alt="OAD Logo">
    <!--<h1>OAD – Affichage Gare</h1>-->
    <h1>Départs – Gare UTB – Abidjan</h1>
  </div>

  <div class="header-right">
    <div id="clock">--:--</div>
    <div id="date"></div>
  </div>
</header>

<div class="main">

  <!-- TABLE -->
  <div class="table-zone">

    <div class="table-header">
      <table>
        <colgroup>
          <col><col><col><col><col>
        </colgroup>
        <thead>
          <tr>
            <th>Numéro</th>
            <th>Destination</th>
            <th>Départ</th>
            <th>Arrivée</th>
            <th>Statut</th>
          </tr>
        </thead>
      </table>
    </div>

    <div class="table-body" id="tableBodyContainer">
      <table>
        <colgroup>
          <col><col><col><col><col>
        </colgroup>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

  </div>

  <!-- PUB -->
  <div class="pub">
    <img id="pub1" class="active">
    <img id="pub2">
  </div>

</div>

<div class="ticker" id="ticker">
  <span id="tickerText"></span>
</div>

<script>
/* ===== API ===== */
const API_URL = "https://script.google.com/macros/s/AKfycbxX654uOxSSdqiSrAnQVV2aShuteAY_XdLQmp4PDE1taDYnCkB5oGL2ot1R-XA2Kwzn/exec";

/* ===== HORLOGE + DATE ===== */
setInterval(() => {
  const now = new Date();

  clock.innerText = now.toLocaleTimeString("fr-FR", {
    hour: "2-digit",
    minute: "2-digit",
    second: "2-digit"
  });

  date.innerText = now.toLocaleDateString("fr-FR", {
    weekday: "long",
    day: "2-digit",
    month: "long",
    year: "numeric"
  });
}, 1000);

/* ===== FORMAT HEURE ===== */
function formatHeure(v) {
  if (!v) return "--:--";
  const d = new Date(v);
  return d.toLocaleTimeString("fr-FR", { hour: "2-digit", minute: "2-digit" });
}

/* ===== PARSE HEURE JOUR ===== */
function parseTodayTime(value) {
  if (!value) return null;
  const d = new Date(value);
  if (!isNaN(d)) {
    const t = new Date();
    t.setHours(d.getHours(), d.getMinutes(), 0, 0);
    return t;
  }
  return null;
}

/* ===== STATUT ===== */
function computeStatut(depart, manuel) {
  if (manuel && manuel.toLowerCase().trim() === "retardé") return "Retardé";
  const dep = parseTodayTime(depart);
  if (!dep) return "";
  const diff = (new Date() - dep) / 60000;
  if (diff < 0) return "À l’heure";
  if (diff < 20) return "Embarquement";
  return "Parti";
}

function getStatutClass(s) {
  if (!s) return "";
  s = s.toLowerCase();
  if (s === "à l’heure") return "statut-ok";
  if (s === "embarquement") return "statut-embarquement";
  if (s === "retardé") return "statut-retard";
  if (s === "parti") return "statut-parti";
  return "";
}

/* ===== PUB ROTATION ===== */
let pubList = [];
let pubIndex = 0;
let showFirst = true;

function rotatePub() {
  if (!pubList.length) return;
  const a = pub1, b = pub2;
  const img = pubList[pubIndex % pubList.length];

  if (showFirst) {
    b.src = img; b.classList.add("active"); a.classList.remove("active");
  } else {
    a.src = img; a.classList.add("active"); b.classList.remove("active");
  }

  showFirst = !showFirst;
  pubIndex++;
}

/* ===== LOAD DATA ===== */
async function loadData() {
  const res = await fetch(API_URL);
  const data = await res.json();

  tableBody.innerHTML = "";
  pubList = [];
  let annonces = [];

  data.forEach(row => {
    const statutFinal = computeStatut(row.depart, row.statut);

    tableBody.innerHTML += `
      <tr>
        <td>${row.numero}</td>
        <td>${row.destination}</td>
        <td>${formatHeure(row.depart)}</td>
        <td>${formatHeure(row.arrivee)}</td>
        <td class="${getStatutClass(statutFinal)}">${statutFinal}</td>
      </tr>
    `;

    if (row.puburl) {
      row.puburl.split(",").forEach(u => {
        const url = u.trim();
        if (url.startsWith("http")) pubList.push(url);
      });
    }

    if (row.annonces) {
      row.annonces.split("|||").forEach(a => annonces.push(a.trim()));
    }
  });

  if (annonces.length) {
    ticker.style.display = "flex";
    tickerText.innerText = annonces.join("   |||   ");
  } else {
    ticker.style.display = "none";
  }
}

/* ===== SCROLL ===== */
let pos = 0, dir = 1;
setInterval(() => {
  const c = tableBodyContainer;
  const max = c.scrollHeight - c.clientHeight;
  if (max <= 0) return;
  pos += dir * 0.4;
  if (pos >= max || pos <= 0) dir *= -1;
  c.scrollTop = pos;
}, 30);

/* ===== INIT ===== */
loadData();
setInterval(loadData, 30000);

rotatePub();
setInterval(rotatePub, 8000);
</script>

</body>
</html>
